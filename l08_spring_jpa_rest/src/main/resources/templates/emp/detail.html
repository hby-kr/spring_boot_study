<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>사원상세</title>
</head>
<body>
<h1>사원상세</h1>
<p> id: <span th:text="${emp.id}"></span></p>
<p> firstName: <span th:text="${emp.firstName}"></span></p>
<p> lastName: <span th:text="${emp.lastName}"></span></p>
<p> birthDate: <span th:text="${emp.birthDate}"></span></p>
<p> hireDate: <span th:text="${emp.hireDate}"></span></p>
<p> gender: <span th:text="${emp.gender}"></span></p>
<hr>

<style>
    .disabled {
        display: none;
    }
</style>

<div>
    <h2>부서이동내역
        <button id="loadDeptBtn">불러오기</button>
        <button id="showDeptRegisterBtn">부서 등록 폼 보기</button>
    </h2>
    
    <h3>부서 등록 폼</h3>
    <form id="deptRegister" class="disabled" action="/dept/register.do" method="post">
        <p><label>사원번호<input name="empNo" th:value="${emp.id}" type="text" readonly></label></p>
        <p><label>부서번호<input name="deptNo" value="d00" type="text"></label></p>
        <p><label>from-date<input name="fromDate" value="2024-01-01" type="date"></label></p>
        <p><label>to-date<input name="toDate" value="2025-01-01" type="date"></label></p>
        <p>
            <button type="reset">초기화</button>
            <button type="submit">등록</button>
        </p>
    </form>
    <div>
        <table>
            <thead>
            <tr>
                <th>사원 ID</th>
                <th>부서 번호</th>
                <th>부서 이름</th>
                <th>from date</th>
                <th>to date</th>
            </tr>
            </thead>

            <tbody id="deptTbody">
            </tbody>
        </table>
    </div>


</div>

<script>
    const EMP_NO = [[${emp.id}]];
    const loadDeptBtn = document.getElementById('loadDeptBtn');
    const deptTbody = document.getElementById('deptTbody');

    const deptRegister = document.getElementById("deptRegister"); //form
    const showDeptRegisterBtn = document.getElementById("showDeptRegisterBtn");

    const loadDept = async function () {
        let url = `/dept/${EMP_NO}/readEmp.do`;
        let response = await fetch(url); // 비동기 함수 == new thread().run()
        let data = await response.json();
        // console.log(data) // 확인작업

        let html = "";
        for (let deptEmp of data) {
            html +=
                `<tr>
                   <td>${deptEmp.empNo}</td>
                   <td>${deptEmp.deptNo}</td>
                   <td>${deptEmp.dept.deptName}</td>
                   <td>${deptEmp.fromDate}</td>
                   <td>${deptEmp.toDate}</td>
                 </tr>`;
        }
        deptTbody.innerHTML = html;
    };
    loadDeptBtn.addEventListener('click', loadDept); // == loadDeptBtn.onclick = loadDept;


    showDeptRegisterBtn.addEventListener("click", () => {
        deptRegister.classList.toggle("disabled"); // 클래스 넣었다 뺐다 toggle로 하면서 style을 클래스에 설정해놓고 보이고 안보이게 만들기
    });


    deptRegister.addEventListener("submit", async (e) => {
        e.preventDefault(); //서비밋 이벤트 막기

        // ㅡㅡㅡㅡ form 데이터를 Object로 받는 방법
        const formData = new FormData(deptRegister); //FormData  form 의 input 데이터를 쉽게 구성하고 처리할 수 있게 한꺼번에 처리해주는 JavaScript 객체
        //Map(key-value) --->  [key, value] // 즉 맵을 배열로 바꿔주는 것이 entry data // 맵의 각 키-값 쌍을 엔트리(Entry)라고 함 (배열의 0,1번째로 만들어지는 것)
        // {id:"경민",age:39}=? ---->  ["id","경민"] ["age",39]
        // 맵 데이터를 자동으로 엔트리 데이터로 바꿔주는 것이 FormData
        // AJAX 요청: XMLHttpRequest나 fetch API와 함께 사용되어 서버로 폼 데이터를 비동기적으로 전송할 수 있습니다.
        // for(let input of formData.entries()){
        //     console.log(input);
        // } // 값을 보려고 한 시도.

        // Entry 데이터로 Object만들기
        const formDataObj = Object.fromEntries(formData.entries());
        //Object.fromEntries : entry 데이터로 Object 생성

        console.log(formDataObj); // {empNo: '11', deptNo: 'd00', fromDate: '2024-01-01', toDate: '2025-01-01'} : Object 의 리터럴 표기법
        console.log(JSON.stringify(formDataObj));
        // {"empNo":"11","deptNo":"d00","fromDate":"2024-01-01","toDate":"2025-01-01"} : JSON : 통신을 위해 Object를 문자열 명세한 것
        // JSON은 Object 문자열 표기법 (NaN,함수가 포함되지 않음,key 와 문자열은 ""로 표시)

        // 객체를 받을 때는 const로 받기
        const response = await fetch("/dept/deptEmp.do", {
            method: "POST",  // http메서드를 post로 보내겠다.
            //body : 요청 정보를 포함하는 해더의 본문
            //headers : 요청 정보에 대한 정보(meta data)
            body: JSON.stringify(formDataObj), // formDataObj를 통신하기 위해 json으로 바꿔서, 헤더 본문에 데이터를 보내겠다.
            headers: {"Content-type": "application/json"},
        });


        const resultObj = await response.json();
        // console.log(resultObj); // 확인해보기
        if (resultObj.result === true) {
            alert(resultObj.msg);
            await loadDept(); //async 할수를 실행할때는 await 를 사용해야한다.
        } else {
            alert("등록할 부서가 없습니다.");
        }

    });


</script>
</body>
</html>